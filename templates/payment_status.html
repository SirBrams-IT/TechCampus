{% extends "student-main.html" %}
{% block body %}

<div class="text-center mt-5">
  <h4 class="text-secondary">Processing Payment...</h4>
  <p class="text-primary">Please complete the payment on your phone.</p>
  
  <!-- Animated progress indicator -->
  <div class="d-flex justify-content-center align-items-center mb-3">
    <div class="spinner-border text-success" role="status" id="main-spinner"></div>
    <div class="ms-3">
      <div class="progress" style="width: 200px; height: 8px;">
        <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" style="width: 0%"></div>
      </div>
    </div>
  </div>
  
  <p id="status-message" class="mt-3 text-muted">Waiting for payment confirmation...</p>
  
  <!-- Debug info -->
  <div class="mt-3 small text-muted">
    <p>Transaction ID: <code id="checkout-id">{{ checkout_id }}</code></p>
    <p>Elapsed time: <span id="elapsed-time">0</span> seconds</p>
    <p id="countdown-timer" class="fw-bold text-danger">Time remaining: 5:00</p>
  </div>
</div>

<!-- Manual fallback section (hidden initially) -->
<div id="manual-fallback" style="display: none;" class="mt-4 p-3 border rounded bg-light text-center">
  <h5 class="text-warning">Having issues?</h5>
  <p class="mb-3">If you've completed the payment but still see this message:</p>
  <a href="{% url 'student_dashboard' %}" class="btn btn-primary me-2">Check Dashboard</a>
  <button onclick="location.reload()" class="btn btn-secondary me-2">Refresh Page</button>
  <a href="{% url 'payment' user_id=studentinfo.id course_id=course.id %}" class="btn btn-outline-warning">Try Again</a>
</div>

<script>
  let pollInterval = null;
  let pollCount = 0;
  const maxPolls = 60; // 5 minutes max (60 * 5s = 5 minutes)
  const totalTime = 300; // 5 minutes = 300 seconds
  let startTime = new Date();
  let elapsedSeconds = 0;

  // Update elapsed time and countdown
  function updateElapsedTime() {
    elapsedSeconds = Math.floor((new Date() - startTime) / 1000);
    document.getElementById('elapsed-time').textContent = elapsedSeconds;

    // Countdown
    let remaining = Math.max(totalTime - elapsedSeconds, 0);
    let minutes = Math.floor(remaining / 60);
    let seconds = remaining % 60;
    document.getElementById('countdown-timer').textContent =
      `Time remaining: ${minutes}:${seconds.toString().padStart(2, '0')}`;

    // Update progress bar (0-100% over 5 minutes = 300s)
    const progressPercent = Math.min((elapsedSeconds / totalTime) * 100, 100);
    document.getElementById('progress-bar').style.width = progressPercent + '%';
  }

  // Update every second
  setInterval(updateElapsedTime, 1000);

  function checkStatus() {
    pollCount++;
    updateElapsedTime();

    // Stop after max polls (5 minutes)
    if (pollCount > maxPolls) {
      clearInterval(pollInterval);
      showTimeout();
      return;
    }

    fetch("{% url 'check_payment_status' user_id course_id checkout_id %}")
      .then(response => {
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
      })
      .then(data => {
        console.log("Poll response:", data);

        if (data.status === "success") {
          clearInterval(pollInterval);
          showSuccess();
        } else if (data.status === "failed") {
          clearInterval(pollInterval);
          showFailure();
        } else {
          // Still pending - update status message occasionally
          if (pollCount % 6 === 0) { // Every 30 seconds
            const messages = [
              "Still waiting for payment confirmation...",
              "Payment processing...",
              "Checking payment status...",
              "Please wait while we confirm your payment..."
            ];
            const randomMessage = messages[Math.floor(Math.random() * messages.length)];
            document.getElementById("status-message").textContent = randomMessage;
          }
        }
      })
      .catch(err => {
        console.error("Poll error:", err);
        if (pollCount % 6 === 0) { // Show connection issue every 30s
          document.getElementById("status-message").innerHTML =
            "<span class='text-warning'>⚠️ Connection issue. Still checking...</span>";
        }
      });
  }

  function showSuccess() {
    document.getElementById("main-spinner").classList.remove("spinner-border", "text-success");
    document.getElementById("main-spinner").classList.add("text-success");
    document.getElementById("main-spinner").innerHTML = "✅";

    document.getElementById("progress-bar").classList.remove("progress-bar-animated");
    document.getElementById("progress-bar").classList.add("bg-success");
    document.getElementById("progress-bar").style.width = "100%";

    document.getElementById("status-message").innerHTML =
      "<span class='text-success fw-bold'>✅ Payment successful! Redirecting to dashboard...</span>";

    setTimeout(() => {
      window.location.href = "{% url 'student_dashboard' %}";
    }, 2000);
  }

  function showFailure() {
    document.getElementById("main-spinner").classList.remove("spinner-border", "text-success");
    document.getElementById("main-spinner").classList.add("text-danger");
    document.getElementById("main-spinner").innerHTML = "❌";

    document.getElementById("progress-bar").classList.remove("progress-bar-animated");
    document.getElementById("progress-bar").classList.add("bg-danger");
    document.getElementById("progress-bar").style.width = "100%";

    document.getElementById("status-message").innerHTML =
      "<span class='text-danger fw-bold'>❌ Payment failed or cancelled.</span>" +
      "<p class='text-muted mt-2'>Redirecting to payment page...</p>";

    setTimeout(() => {
      window.location.href = "{% url 'payment' user_id=studentinfo.id course_id=course.id %}";
    }, 2000);
  }

  function showTimeout() {
    document.getElementById("main-spinner").classList.remove("spinner-border", "text-success");
    document.getElementById("main-spinner").classList.add("text-warning");
    document.getElementById("main-spinner").innerHTML = "⏰";

    document.getElementById("progress-bar").classList.remove("progress-bar-animated");
    document.getElementById("progress-bar").classList.add("bg-warning");
    document.getElementById("progress-bar").style.width = "100%";

    document.getElementById("status-message").innerHTML =
      "<span class='text-warning fw-bold'>⏰ No payments made.</span>" +
      "<p class='text-muted'>Redirecting to payment page...</p>";

    setTimeout(() => {
      window.location.href = "{% url 'payment' user_id=studentinfo.id course_id=course.id %}";
    }, 3000);
  }

  // Start polling immediately
  checkStatus();
  pollInterval = setInterval(checkStatus, 5000); // Check every 5 seconds
</script>


<br><br><br><br><br><br>
{% endblock %}