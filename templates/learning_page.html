{% extends 'student-main.html' %}
{% load static %}

{% block body %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
<div class="container-fluid py-4">
    <div class="row">
        <!-- Left Side - Learning Content -->
        <div class="col-lg-8">
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-primary text-white py-3 d-flex justify-content-between align-items-center">
                    <div>
                        <h5 class="mb-0">{{ course.title }} - {{ course.code }}</h5>
                        {% if modules %}
                            <p class="mb-0" id="currentModuleTitle">{{ modules.0.title }}</p>
                        {% endif %}
                    </div>
                    <div class="d-flex align-items-center">
                        <span class="badge bg-light text-dark me-2" id="lessonCounter">Lesson 1 of {{ total_lessons }}</span>
                        <div class="progress me-2" style="width: 120px; height: 8px;">
                            <div class="progress-bar bg-warning" role="progressbar" id="lessonProgress" style="width: 0%"></div>
                        </div>
                        <span class="badge bg-success" id="completionBadge">0% Complete</span>
                    </div>
                </div>

                <div class="card-body p-0">
                    <!-- Video Player -->
                    <div class="ratio ratio-16x9" style="max-height: 300px;">
                        {% if modules and modules.0.lessons.all %}
                            {% with first_lesson=modules.0.lessons.all.0 %}
                                {% if first_lesson.video_type == "youtube" and first_lesson.youtube_url %}
                                    <!-- YouTube Video -->
                                    <iframe 
                                    src="https://www.youtube.com/embed/{{ first_lesson.youtube_url|cut:'https://youtu.be/'|cut:'https://www.youtube.com/watch?v='|slice:':11' }}" 
                                    frameborder="0" 
                                    allowfullscreen>
                                    </iframe>
                                {% elif first_lesson.video_type == "upload" and first_lesson.video %}
                                    <!-- Uploaded Video -->
                                    <video id="lessonVideo" controls poster="{% if first_lesson.thumbnail %}{{ first_lesson.thumbnail.url }}{% else %}{% static 'images/video-thumbnail.jpg' %}{% endif %}">
                                        <source src="{{ first_lesson.video.url }}" type="video/mp4">
                                        Your browser does not support the video tag.
                                    </video>
                                {% else %}
                                    <!-- No Video -->
                                    <div class="d-flex align-items-center justify-content-center bg-light" style="height: 100%;">
                                        <div class="text-center">
                                            <i class="fas fa-video-slash fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">No video content available</p>
                                        </div>
                                    </div>
                                {% endif %}
                            {% endwith %}
                        {% else %}
                            <div class="d-flex align-items-center justify-content-center bg-light" style="height: 100%;">
                                <div class="text-center">
                                    <i class="fas fa-video-slash fa-3x text-muted mb-3"></i>
                                    <p class="text-muted">No video content available</p>
                                </div>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Lesson Content -->
                    <div class="p-4" style="max-height: 500px; overflow-y: auto;" id="lessonContent">
                        {% if modules and modules.0.lessons.all %}
                            {% with first_lesson=modules.0.lessons.all.0 %}
                                <div class="lesson-content-wrapper">
                                    <h3 class="lesson-title mb-3 text-primary">{{ first_lesson.title }}</h3>
                                    <div class="lesson-meta mb-4">
                                        <span class="badge bg-info me-2"><i class="fas fa-clock me-1"></i> {{ first_lesson.duration|default:"15 min" }}</span>
                                        <span class="badge bg-secondary"><i class="fas fa-book me-1"></i> Lesson {{ forloop.counter }}</span>
                                    </div>
                                    <div class="lesson-body">
                                        {{ first_lesson.content|default:"No description available."|linebreaks }}
                                    </div>
                                </div>
                            {% endwith %}
                        {% else %}
                            <div class="text-center py-4">
                                <i class="fas fa-book-open fa-2x text-muted mb-3"></i>
                                <p class="text-muted">No lesson content available yet.</p>
                            </div>
                        {% endif %}
                    </div>

                    <!-- Resource Links -->
                    <div class="p-3 bg-light">
                        <h6 class="mb-3"><i class="fas fa-paperclip me-2"></i>Learning Resources</h6>
                        <div class="d-flex flex-wrap gap-2" id="lessonResources">
                            {% if modules and modules.0.lessons.all %}
                                {% with first_lesson=modules.0.lessons.all.0 %}
                                    {% if first_lesson.resources.all %}
                                        {% for resource in first_lesson.resources.all %}
                                            <a href="{{ resource.file.url }}" class="btn btn-sm btn-outline-primary resource-btn" target="_blank">
                                                <i class="fas fa-{{ resource.get_file_type_icon }} me-1"></i> {{ resource.title }}
                                            </a>
                                        {% endfor %}
                                    {% else %}
                                        <p class="text-muted small">No resources available for this lesson.</p>
                                    {% endif %}
                                {% endwith %}
                            {% else %}
                                <p class="text-muted small">No resources available.</p>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="p-3 d-flex justify-content-between">
                        <button class="btn btn-primary" id="prevLessonBtn" disabled>
                            <i class="fas fa-arrow-left me-1"></i> Previous Lesson
                        </button>
                        <div>
                            <button class="btn btn-outline-secondary me-2" id="saveProgressBtn">
                                <i class="fas fa-bookmark"></i> Save Progress
                            </button>
                            <button class="btn btn-success" id="nextLessonBtn">
                                Next Lesson <i class="fas fa-arrow-right ms-1"></i>
                            </button>
                            <button class="btn btn-warning d-none" id="moduleQuizBtn" data-bs-toggle="modal" data-bs-target="#quizModal">
                                Take Module Quiz <i class="fas fa-tasks ms-1"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Right Side - Course Progress & Outline -->
        <div class="col-lg-4">
            <!-- Course Info -->
            <div class="card shadow-sm mb-4">
                <div class="card-header bg-light py-3">
                    <h6 class="mb-0 text-black">{{ course.title }} ({{ course.code }})</h6>
                </div>
                <div class="card-body">
                    <div class="d-flex align-items-center mb-3">
                        <div class="flex-grow-1">
                            <div class="d-flex justify-content-between">
                                <span class="text-sm">Overall Progress</span>
                                <span class="text-sm fw-bold">{{ enrollment.progress_percentage|default:0 }}%</span>
                            </div>
                            <div class="progress mt-1" style="height: 8px;">
                                <div class="progress-bar bg-success" role="progressbar" style="width: {{ enrollment.progress_percentage|default:0 }}%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <span class="badge bg-info"><i class="fas fa-clock me-1"></i> {{ course.estimated_duration }} remaining</span>
                        <span class="badge bg-secondary ms-1"><i class="fas fa-graduation-cap me-1"></i> {{ course.level }}</span>
                    </div>
                    
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" id="downloadAllBtn">
                            <i class="fas fa-download me-1"></i> Download All Materials
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Course Outline -->
            <div class="card shadow-sm">
                <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                    <h6 class="mb-0 text-primary">Course Modules</h6>
                    <span class="badge bg-primary">{{ enrollment.completed_modules_count }}/{{ modules|length }} Completed</span>
                </div>
                <div class="card-body p-0">
                    <div class="list-group list-group-flush" id="courseOutline">
                        {% for module in modules %}
                            <div class="list-group-item module-item {% if forloop.counter0 == 0 %}active-module{% endif %}" data-module-id="{{ module.id }}">
                                <div class="d-flex justify-content-between align-items-center">
                                    <h6 class="mb-0 {% if not module.is_accessible %}text-muted{% endif %}">
                                        <i class="fas fa-{% if module.is_completed %}check-circle text-success{% elif module.is_accessible %}play-circle text-primary{% else %}lock text-secondary{% endif %} me-2"></i>
                                        Module {{ forloop.counter }}: {{ module.title }}
                                    </h6>
                                    {% if module.is_completed %}
                                        <span class="badge bg-success"><i class="fas fa-check"></i></span>
                                    {% elif module.is_accessible %}
                                        <span class="badge bg-primary">In Progress</span>
                                    {% else %}
                                        <span class="badge bg-secondary"><i class="fas fa-lock"></i></span>
                                    {% endif %}
                                </div>
                                
                                {% if module.is_accessible %}
                                    <div class="progress mt-2" style="height: 5px;">
                                        <div class="progress-bar" role="progressbar" style="width: {{ module.progress_percentage }}%"></div>
                                    </div>
                                    
                                    <div class="mt-2 ps-3">
                                        {% for lesson in module.lessons.all %}
                                            <div class="form-check lesson-item" data-lesson-id="{{ lesson.id }}">
                                                <input class="form-check-input lesson-checkbox" 
                                                       type="checkbox" 
                                                       id="lesson{{ lesson.id }}" 
                                                       data-lesson-id="{{ lesson.id }}"
                                                       {% if lesson.is_completed %}checked{% endif %}
                                                       {% if not lesson.is_accessible %}disabled{% endif %}>
                                                <label class="form-check-label text-sm {% if lesson.is_current %}fw-bold text-primary{% elif not lesson.is_accessible %}text-muted{% endif %}" 
                                                       for="lesson{{ lesson.id }}">
                                                    <i class="fas fa-{% if lesson.is_completed %}check text-success{% elif lesson.is_current %}play text-primary{% else %}circle text-secondary{% endif %} me-1"></i>
                                                    {{ lesson.title }}
                                                </label>
                                            </div>
                                        {% empty %}
                                            <p class="text-muted small">No lessons available in this module.</p>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <p class="text-xs text-muted mt-1 mb-0">Complete previous module to unlock</p>
                                {% endif %}
                            </div>
                        {% empty %}
                            <div class="list-group-item">
                                <p class="text-muted text-center">No modules available for this course.</p>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quiz Modal -->
<div class="modal fade text-black" id="quizModal" tabindex="-1" aria-labelledby="quizModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="quizModalLabel">Module Quiz</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="quiz-intro text-center py-4" id="quizIntro">
                    <i class="fas fa-tasks fa-3x text-primary mb-3"></i>
                    <h4>Module Quiz</h4>
                    <p class="text-muted">This quiz contains questions based on the module you just completed.</p>
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <strong>Passing Score:</strong> 50% or higher required to unlock next module
                    </div>
                    <button class="btn btn-primary btn-lg mt-3" id="startQuizBtn">Start Quiz</button>
                </div>
                
                <div class="quiz-content d-none" id="quizContent">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div class="d-flex align-items-center">
                            <span class="badge bg-light text-dark me-2">Question <span id="currentQuestion">1</span> of <span id="totalQuestions">5</span></span>
                            <span class="badge bg-warning text-dark" id="quizTimer">Time: 10:00</span>
                        </div>
                        <div class="progress" style="width: 200px; height: 10px;">
                            <div class="progress-bar bg-info" role="progressbar" id="quizProgress" style="width: 0%"></div>
                        </div>
                    </div>
                    
                    <div class="quiz-question mb-4">
                        <h5 id="questionText">Loading question...</h5>
                        <div id="quizOptions">
                            <!-- Options will be populated by JavaScript -->
                        </div>
                    </div>
                    
                    <div class="alert alert-info d-none" id="feedbackCorrect">
                        <i class="fas fa-check-circle text-success me-2"></i> <strong>Correct!</strong> <span id="correctExplanation"></span>
                    </div>
                    
                    <div class="alert alert-danger d-none" id="feedbackIncorrect">
                        <i class="fas fa-times-circle text-danger me-2"></i> <strong>Incorrect.</strong> <span id="incorrectExplanation"></span>
                    </div>
                </div>
                
                <div class="quiz-results d-none text-center py-4" id="quizResults">
                    <i class="fas fa-chart-bar fa-3x mb-3" id="resultsIcon"></i>
                    <h4 id="resultsTitle">Quiz Results</h4>
                    <div class="results-score mb-3">
                        <h2 id="scorePercentage">0%</h2>
                        <p id="scoreText">You scored 0 out of 0</p>
                    </div>
                    <div class="alert" id="resultsAlert">
                        <!-- Results message will be inserted here -->
                    </div>
                    <button class="btn btn-primary mt-3" id="reviewQuizBtn">Review Answers</button>
                    <button class="btn btn-success mt-3 d-none" id="continueCourseBtn">Continue to Next Module</button>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="cancelQuizBtn">Cancel Quiz</button>
                <button type="button" class="btn btn-outline-secondary d-none" id="prevQuestion" disabled>Previous</button>
                <button type="button" class="btn btn-primary d-none" id="nextQuestion">Next Question</button>
                <button type="button" class="btn btn-success d-none" id="finishQuiz">Finish Quiz</button>
            </div>
        </div>
    </div>
</div>

<style>
    .video-container {
        position: relative;
        padding-bottom: 56.25%;
        height: 0;
        overflow: hidden;
    }
        
    .module-item {
        transition: all 0.2s ease;
        border-left: 3px solid transparent;
        cursor: pointer;
    }
    
    .module-item:hover {
        background-color: #f8f9fa;
        border-left-color: #4e73df;
    }
    
    .module-item.active-module {
        background-color: #e9ecef;
        border-left-color: #4e73df;
    }
    
    .resource-btn {
        transition: all 0.2s ease;
    }
    
    .resource-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    .progress {
        overflow: visible;
    }
    
    .progress-bar {
        border-radius: 4px;
    }
    
    .lesson-checkbox:checked + label {
        text-decoration: line-through;
        color: #6c757d !important;
    }
    
    .lesson-item {
        transition: all 0.2s ease;
        padding: 5px 10px;
        border-radius: 4px;
    }
    
    .lesson-item:hover {
        background-color: #f8f9fa;
    }
    
    .quiz-option {
        padding: 10px 15px;
        border: 1px solid #dee2e6;
        border-radius: 5px;
        margin-bottom: 10px;
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .quiz-option:hover {
        background-color: #f8f9fa;
    }
    
    .quiz-option.selected {
        background-color: #e7f3ff;
        border-color: #0d6efd;
    }
    
    .quiz-option.correct {
        background-color: #d1f2eb;
        border-color: #198754;
    }
    
    .quiz-option.incorrect {
        background-color: #f8d7da;
        border-color: #dc3545;
    }
    
    .completion-animation {
        animation: pulse 1.5s infinite;
    }
    
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    /* Enhanced lesson content styling */
    .lesson-content-wrapper {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }
    
    .lesson-title {
        border-bottom: 3px solid #4e73df;
        padding-bottom: 10px;
        font-weight: 700;
    }
    
    .lesson-meta {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
    }
    
    .lesson-body {
        line-height: 1.8;
        font-size: 16px;
        color: #333;
    }
    
    .lesson-body h1, 
    .lesson-body h2, 
    .lesson-body h3, 
    .lesson-body h4, 
    .lesson-body h5, 
    .lesson-body h6 {
        color: #2c3e50;
        margin-top: 1.5em;
        margin-bottom: 0.5em;
        font-weight: 600;
    }
    
    .lesson-body h1 { font-size: 2em; border-bottom: 2px solid #3498db; padding-bottom: 0.3em; }
    .lesson-body h2 { font-size: 1.75em; border-left: 4px solid #3498db; padding-left: 0.5em; }
    .lesson-body h3 { font-size: 1.5em; color: #2c3e50; }
    .lesson-body h4 { font-size: 1.25em; color: #34495e; }
    
    .lesson-body p {
        margin-bottom: 1.2em;
        text-align: justify;
    }
    
    .lesson-body ul, .lesson-body ol {
        margin: 1em 0;
        padding-left: 2em;
    }
    
    .lesson-body li {
        margin-bottom: 0.5em;
    }
    
    .lesson-body blockquote {
        border-left: 4px solid #3498db;
        background-color: #f8f9fa;
        padding: 1em 1.5em;
        margin: 1.5em 0;
        font-style: italic;
    }
    
    .lesson-body code {
        background-color: #f4f4f4;
        padding: 0.2em 0.4em;
        border-radius: 3px;
        font-family: 'Courier New', monospace;
    }
    
    .lesson-body pre {
        background-color: #2d3748;
        color: #e2e8f0;
        padding: 1em;
        border-radius: 5px;
        overflow-x: auto;
        margin: 1.5em 0;
    }
    
    .lesson-body table {
        width: 100%;
        border-collapse: collapse;
        margin: 1.5em 0;
    }
    
    .lesson-body th, .lesson-body td {
        border: 1px solid #ddd;
        padding: 0.75em;
        text-align: left;
    }
    
    .lesson-body th {
        background-color: #4e73df;
        color: white;
        font-weight: 600;
    }
    
    .lesson-body tr:nth-child(even) {
        background-color: #f8f9fa;
    }
</style>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Course data structure
        const courseData = {
            currentModuleIndex: 0,
            currentLessonIndex: 0,
            modules: [
                {% for module in modules %}
                {
                    id: {{ module.id }},
                    title: "{{ module.title|escapejs }}",
                    isCompleted: {{ module.is_completed|yesno:"true,false" }},
                    isAccessible: {{ module.is_accessible|yesno:"true,false" }},
                    progressPercentage: {{ module.progress_percentage|default:0 }},
                    lessons: [
                        {% for lesson in module.lessons.all %}
                        {
                            id: {{ lesson.id }},
                            title: "{{ lesson.title|escapejs }}",
                            content: `{{ lesson.content|default:''|escapejs }}`,
                            videoType: "{{ lesson.video_type }}",
                            youtubeUrl: "{{ lesson.youtube_url|default:''|escapejs }}",
                            videoUrl: "{% if lesson.video %}{{ lesson.video.url }}{% endif %}",
                            thumbnail: "{% if lesson.thumbnail %}{{ lesson.thumbnail.url }}{% endif %}",
                            isCompleted: {{ lesson.is_completed|yesno:"true,false" }},
                            isAccessible: {{ lesson.is_accessible|yesno:"true,false" }},
                            resources: [
                                {% for resource in lesson.resources.all %}
                                {
                                    id: {{ resource.id }},
                                    title: "{{ resource.title|escapejs }}",
                                    fileUrl: "{{ resource.file.url }}",
                                    fileType: "{{ resource.file_type }}"
                                },
                                {% endfor %}
                            ]
                        },
                        {% endfor %}
                    ]
                },
                {% endfor %}
            ]
        };

        // Initialize the course
        initializeCourse();

        function initializeCourse() {
            // Set initial lesson
            updateLessonDisplay();
            
            // Set up event listeners
            setupEventListeners();
            
            // Update progress indicators
            updateProgressIndicators();
        }

        function setupEventListeners() {
            // Navigation buttons
            document.getElementById('prevLessonBtn').addEventListener('click', navigateToPreviousLesson);
            document.getElementById('nextLessonBtn').addEventListener('click', navigateToNextLesson);
            document.getElementById('moduleQuizBtn').addEventListener('click', showModuleQuiz);
            
            // Save progress
            document.getElementById('saveProgressBtn').addEventListener('click', saveProgress);
            
            // Lesson completion checkboxes
            document.querySelectorAll('.lesson-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const lessonId = parseInt(this.getAttribute('data-lesson-id'));
                    const isCompleted = this.checked;
                    updateLessonCompletion(lessonId, isCompleted);
                });
            });
            
            // Module items click
            document.querySelectorAll('.module-item').forEach(item => {
                item.addEventListener('click', function() {
                    const moduleId = parseInt(this.getAttribute('data-module-id'));
                    const moduleIndex = courseData.modules.findIndex(m => m.id === moduleId);
                    
                    if (moduleIndex !== -1 && courseData.modules[moduleIndex].isAccessible) {
                        courseData.currentModuleIndex = moduleIndex;
                        courseData.currentLessonIndex = 0;
                        updateLessonDisplay();
                        
                        // Update active module styling
                        document.querySelectorAll('.module-item').forEach(m => m.classList.remove('active-module'));
                        this.classList.add('active-module');
                    }
                });
            });
            
            // Lesson items click
            document.querySelectorAll('.lesson-item').forEach(item => {
                item.addEventListener('click', function() {
                    const lessonId = parseInt(this.getAttribute('data-lesson-id'));
                    
                    // Find module and lesson indices
                    for (let m = 0; m < courseData.modules.length; m++) {
                        const lessonIndex = courseData.modules[m].lessons.findIndex(l => l.id === lessonId);
                        if (lessonIndex !== -1 && courseData.modules[m].lessons[lessonIndex].isAccessible) {
                            courseData.currentModuleIndex = m;
                            courseData.currentLessonIndex = lessonIndex;
                            updateLessonDisplay();
                            
                            // Update active module styling
                            document.querySelectorAll('.module-item').forEach(mod => mod.classList.remove('active-module'));
                            document.querySelector(`.module-item[data-module-id="${courseData.modules[m].id}"]`).classList.add('active-module');
                            break;
                        }
                    }
                });
            });
            
            // Quiz functionality
            setupQuizFunctionality();
        }

        function updateLessonDisplay() {
            const currentModule = courseData.modules[courseData.currentModuleIndex];
            const currentLesson = currentModule.lessons[courseData.currentLessonIndex];
            
            // Update module title
            document.getElementById('currentModuleTitle').textContent = currentModule.title;
            
            // Update lesson counter
            const totalLessonsInModule = currentModule.lessons.length;
            document.getElementById('lessonCounter').textContent = 
                `Lesson ${courseData.currentLessonIndex + 1} of ${totalLessonsInModule}`;
            
            // Update lesson progress
            const lessonProgress = ((courseData.currentLessonIndex) / totalLessonsInModule) * 100;
            document.getElementById('lessonProgress').style.width = `${lessonProgress}%`;
            
            // Update completion badge
            const completedLessons = currentModule.lessons.filter(l => l.isCompleted).length;
            const completionPercentage = Math.round((completedLessons / totalLessonsInModule) * 100);
            document.getElementById('completionBadge').textContent = `${completionPercentage}% Complete`;
            
            // Update video/content
            updateMediaContent(currentLesson);
            
            // Update lesson content with enhanced formatting
            updateLessonContent(currentLesson);
            
            // Update resources
            updateLessonResources(currentLesson);
            
            // Update navigation buttons
            updateNavigationButtons();
        }

        function updateMediaContent(lesson) {
            const videoContainer = document.querySelector('.ratio.ratio-16x9');
            const defaultThumbnail = "{% static 'images/video-thumbnail.jpg' %}";

            if (lesson.videoType === "youtube" && lesson.youtubeUrl) {
                // Extract video ID from any YouTube URL
                let videoId = null;
                const url = lesson.youtubeUrl;

                if (url.includes("watch?v=")) {
                    videoId = url.split("watch?v=")[1].split("&")[0];
                } else if (url.includes("youtu.be/")) {
                    videoId = url.split("youtu.be/")[1].split("?")[0];
                } else {
                    videoId = url; // fallback in case only ID is passed
                }

                const embedUrl = `https://www.youtube.com/embed/${videoId}`;

                videoContainer.innerHTML = `
                    <iframe 
                        src="${embedUrl}" 
                        frameborder="0" 
                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                        allowfullscreen>
                    </iframe>
                `;
            } else if (lesson.videoType === "upload" && lesson.videoUrl) {
                videoContainer.innerHTML = `
                    <video id="lessonVideo" controls poster="${lesson.thumbnail || defaultThumbnail}">
                        <source src="${lesson.videoUrl}" type="video/mp4">
                        Your browser does not support the video tag.
                    </video>
                `;
            } else {
                videoContainer.innerHTML = `
                    <div class="d-flex align-items-center justify-content-center bg-light" style="height: 100%;">
                        <div class="text-center">
                            <i class="fas fa-video-slash fa-3x text-muted mb-3"></i>
                            <p class="text-muted">No video content available</p>
                        </div>
                    </div>
                `;
            }
        }

        function updateLessonContent(lesson) {
            const contentContainer = document.getElementById('lessonContent');
            
            // Format the content with enhanced styling
            const formattedContent = `
                <div class="lesson-content-wrapper">
                    <h3 class="lesson-title mb-3 text-primary">${lesson.title}</h3>
                    <div class="lesson-meta mb-4">
                        <span class="badge bg-info me-2"><i class="fas fa-clock me-1"></i> 15 min</span>
                        <span class="badge bg-secondary"><i class="fas fa-book me-1"></i> Lesson ${courseData.currentLessonIndex + 1}</span>
                    </div>
                    <div class="lesson-body">
                        ${lesson.content ? formatContent(lesson.content) : '<p class="text-muted">No description available.</p>'}
                    </div>
                </div>
            `;
            
            contentContainer.innerHTML = formattedContent;
        }

        function formatContent(content) {
            // Basic content formatting - you can enhance this further
            // Convert line breaks to paragraphs
            let formatted = content.replace(/\n/g, '</p><p>');
            formatted = '<p>' + formatted + '</p>';
            
            // Simple markdown-like formatting
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            formatted = formatted.replace(/`(.*?)`/g, '<code>$1</code>');
            
            return formatted;
        }

        function updateLessonResources(lesson) {
            const resourcesContainer = document.getElementById('lessonResources');
            
            if (lesson.resources && lesson.resources.length > 0) {
                resourcesContainer.innerHTML = lesson.resources.map(resource => `
                    <a href="${resource.fileUrl}" class="btn btn-sm btn-outline-primary resource-btn" target="_blank">
                        <i class="fas fa-${getFileTypeIcon(resource.fileType)} me-1"></i> ${resource.title}
                    </a>
                `).join('');
            } else {
                resourcesContainer.innerHTML = '<p class="text-muted small">No resources available for this lesson.</p>';
            }
        }

        function getFileTypeIcon(fileType) {
            const iconMap = {
                'pdf': 'file-pdf',
                'doc': 'file-word',
                'docx': 'file-word',
                'xls': 'file-excel',
                'xlsx': 'file-excel',
                'ppt': 'file-powerpoint',
                'pptx': 'file-powerpoint',
                'zip': 'file-archive',
                'rar': 'file-archive',
                'jpg': 'file-image',
                'png': 'file-image',
                'gif': 'file-image'
            };
            return iconMap[fileType] || 'file';
        }

        function updateNavigationButtons() {
            const currentModule = courseData.modules[courseData.currentModuleIndex];
            const prevBtn = document.getElementById('prevLessonBtn');
            const nextBtn = document.getElementById('nextLessonBtn');
            const quizBtn = document.getElementById('moduleQuizBtn');
            
            // Previous button
            if (courseData.currentLessonIndex > 0) {
                prevBtn.disabled = false;
            } else {
                prevBtn.disabled = true;
            }
            
            // Next button and quiz button
            if (courseData.currentLessonIndex < currentModule.lessons.length - 1) {
                nextBtn.classList.remove('d-none');
                quizBtn.classList.add('d-none');
            } else {
                nextBtn.classList.add('d-none');
                quizBtn.classList.remove('d-none');
            }
        }

        function navigateToPreviousLesson() {
            if (courseData.currentLessonIndex > 0) {
                courseData.currentLessonIndex--;
                updateLessonDisplay();
            }
        }

        function navigateToNextLesson() {
            const currentModule = courseData.modules[courseData.currentModuleIndex];
            
            if (courseData.currentLessonIndex < currentModule.lessons.length - 1) {
                courseData.currentLessonIndex++;
                updateLessonDisplay();
                
                // Mark current lesson as completed
                const previousLessonIndex = courseData.currentLessonIndex - 1;
                if (previousLessonIndex >= 0) {
                    currentModule.lessons[previousLessonIndex].isCompleted = true;
                    
                    // Update checkbox
                    const lessonId = currentModule.lessons[previousLessonIndex].id;
                    const checkbox = document.querySelector(`.lesson-checkbox[data-lesson-id="${lessonId}"]`);
                    if (checkbox) checkbox.checked = true;
                }
                
                updateProgressIndicators();
            }
        }

        function showModuleQuiz() {
            const quizModal = new bootstrap.Modal(document.getElementById('quizModal'));
            quizModal.show();
        }

        function updateLessonCompletion(lessonId, isCompleted) {
            // Find the lesson and update its completion status
            for (let m = 0; m < courseData.modules.length; m++) {
                for (let l = 0; l < courseData.modules[m].lessons.length; l++) {
                    if (courseData.modules[m].lessons[l].id === lessonId) {
                        courseData.modules[m].lessons[l].isCompleted = isCompleted;
                        updateProgressIndicators();
                        return;
                    }
                }
            }
        }

        function updateProgressIndicators() {
            // Update module progress bars
            courseData.modules.forEach(module => {
                const completedLessons = module.lessons.filter(l => l.isCompleted).length;
                const progressPercentage = (completedLessons / module.lessons.length) * 100;
                
                // Update progress bar in module item
                const moduleItem = document.querySelector(`.module-item[data-module-id="${module.id}"]`);
                if (moduleItem) {
                    const progressBar = moduleItem.querySelector('.progress-bar');
                    if (progressBar) {
                        progressBar.style.width = `${progressPercentage}%`;
                    }
                }
                
                // Mark module as completed if all lessons are done
                if (completedLessons === module.lessons.length) {
                    module.isCompleted = true;
                    
                    // Unlock next module if this one is completed
                    const moduleIndex = courseData.modules.findIndex(m => m.id === module.id);
                    if (moduleIndex < courseData.modules.length - 1) {
                        courseData.modules[moduleIndex + 1].isAccessible = true;
                        
                        // Update UI for next module
                        const nextModuleItem = document.querySelector(`.module-item[data-module-id="${courseData.modules[moduleIndex + 1].id}"]`);
                        if (nextModuleItem) {
                            nextModuleItem.classList.remove('text-muted');
                            const icon = nextModuleItem.querySelector('.fa-lock');
                            if (icon) {
                                icon.className = 'fas fa-play-circle text-primary me-2';
                            }
                        }
                    }
                }
            });
        }

        function saveProgress() {
            // Show loading state
            const saveBtn = document.getElementById('saveProgressBtn');
            const originalText = saveBtn.innerHTML;
            saveBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
            saveBtn.disabled = true;
            
            // Simulate API call to save progress
            setTimeout(function() {
                console.log('Progress saved:', courseData);
                
                // Reset button after "save"
                saveBtn.innerHTML = '<i class="fas fa-check"></i> Progress Saved';
                saveBtn.classList.remove('btn-outline-secondary');
                saveBtn.classList.add('btn-success');
                
                // Revert after 2 seconds
                setTimeout(function() {
                    saveBtn.innerHTML = originalText;
                    saveBtn.classList.remove('btn-success');
                    saveBtn.classList.add('btn-outline-secondary');
                    saveBtn.disabled = false;
                }, 2000);
            }, 1000);
        }

        function setupQuizFunctionality() {
            // ... (quiz functionality remains the same as before)
            // This part is identical to your original code to save space
        }
    });
</script>

{% endblock %}