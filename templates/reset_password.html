{% extends 'main-page.html' %}
{% load static %}

{% block body %}
<div class="bg-light min-vh-100 d-flex align-items-center">
    <div class="container d-flex justify-content-center py-5">
        <div class="card p-4 shadow-lg border-0 rounded-4" style="max-width: 550px; width: 100%;">
            
            <!-- Logo -->
            <div class="text-center mb-3">
                <img src="{% static 'assets/img/logo.png' %}" alt="Logo" style="height:70px; width:auto;">
            </div>

            <!-- Heading -->
            <h4 class="text-center fw-bold mb-2">Verify OTP & Reset Password</h4>
            <p class="text-muted text-center mb-4">Enter the OTP sent to your email and set a new password.</p>

            <!-- Messages -->
            {% if messages %}
              {% for message in messages %}
                  {% if message.tags == "success" %}
                      <div class="alert alert-success text-center rounded-3 py-2 message-auto-hide">
                          {{ message }}
                      </div>
                  {% elif message.tags == "error" %}
                      <div class="alert alert-danger text-center rounded-3 py-2 message-auto-hide">
                          {{ message }}
                      </div>
                  {% else %}
                      <div class="alert alert-info text-center rounded-3 py-2 message-auto-hide">
                          {{ message }}
                      </div>
                  {% endif %}
              {% endfor %}
          {% endif %}


            <!-- Form -->
            <form method="POST">
                {% csrf_token %}
                
                <!-- OTP Field -->
                <div class="mb-3">
                    <label for="otp_code" class="form-label fw-semibold">Enter OTP</label>
                    <input type="text" name="otp_code" id="otp_code" class="form-control rounded-3" placeholder="Enter OTP code" required>
                </div>

                <!-- New Password Field -->
                <div class="mb-3">
                    <label class="form-label fw-semibold">New Password</label>
                    <div class="input-group input-group-lg">
                        <input type="password" name="new_password" id="new_password" class="form-control" placeholder="Create a strong password" required>
                        <button type="button" class="btn btn-outline-secondary" id="togglePassword">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                </div>

                <!-- Password Strength -->
                <div class="mb-3">
                    <div class="d-flex justify-content-between mb-1">
                        <small class="fw-semibold">Password Strength</small>
                        <small id="strength-text" class="fw-bold text-danger">Weak</small>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div id="password-strength-bar" class="progress-bar bg-danger" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>

                <!-- Checklist -->
                <div class="mb-4">
                    <small class="fw-semibold d-block mb-2">Password Requirements:</small>
                    <ul id="password-checklist" class="list-unstyled">
                        <li id="length" class="text-danger mb-1"><i class="bi bi-x-circle-fill me-1"></i> At least 8 characters</li>
                        <li id="number" class="text-danger mb-1"><i class="bi bi-x-circle-fill me-1"></i> At least 1 number</li>
                        <li id="uppercase" class="text-danger mb-1"><i class="bi bi-x-circle-fill me-1"></i> At least 1 uppercase letter</li>
                        <li id="special" class="text-danger mb-1"><i class="bi bi-x-circle-fill me-1"></i> At least 1 special character (!@#$%^&*)</li>
                    </ul>
                </div>

                <!-- Confirm Password Field -->
                <div class="mb-4">
                    <label class="form-label fw-semibold">Confirm Password</label>
                    <div class="input-group input-group-lg">
                        <input type="password" name="confirm_password" id="confirm_password" class="form-control" placeholder="Re-enter your password" required>
                        <button type="button" class="btn btn-outline-secondary" id="toggleConfirmPassword">
                            <i class="fa fa-eye"></i>
                        </button>
                    </div>
                    <div id="password-match" class="form-text fw-bold mt-1"></div>
                </div>

                <!-- Submit Button -->
                <button type="submit" class="btn btn-danger w-100 py-2 rounded-3 fw-semibold">
                    Reset Password
                </button>
            </form>

            <!-- Footer Links -->
            <div class="text-center mt-4 small">
                <p class="mb-1">
                    Didn't receive OTP? 
                    <span id="resend-section">
                      <a href="{% url 'reset-request' %}">
                        <button type="button" id="resend-link" class="btn btn-link p-0 fw-semibold">Resend OTP</button>
                      </a>    
                      </span>
                </p>
                <a href="{% url 'login' %}" class="text-decoration-none fw-semibold">← Back to Login</a>
            </div>
        </div>
    </div>
</div>

<!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    const passwordInput = document.getElementById('new_password');
    const togglePassword = document.getElementById('togglePassword');
    const confirmInput = document.getElementById('confirm_password');
    const toggleConfirm = document.getElementById('toggleConfirmPassword');
    const strengthBar = document.getElementById('password-strength-bar');
    const strengthText = document.getElementById('strength-text');
    const matchText = document.getElementById('password-match');
    const checklist = {
        length: document.getElementById('length'),
        number: document.getElementById('number'),
        uppercase: document.getElementById('uppercase'),
        special: document.getElementById('special')
    };
    const resendBtn = document.getElementById('resend-link');
    let timer = 60;

    // Toggle New Password
    togglePassword.addEventListener('click', () => {
        const type = passwordInput.type === "password" ? "text" : "password";
        passwordInput.type = type;
        togglePassword.innerHTML = type === "password" ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
    });

    // Toggle Confirm Password
    toggleConfirm.addEventListener('click', () => {
        const type = confirmInput.type === "password" ? "text" : "password";
        confirmInput.type = type;
        toggleConfirm.innerHTML = type === "password" ? '<i class="fa fa-eye"></i>' : '<i class="fa fa-eye-slash"></i>';
    });

    // Password Strength
    passwordInput.addEventListener('input', () => {
        const val = passwordInput.value;
        let strength = 0;

        checklist.length.className = val.length >= 8 ? "text-success" : "text-danger";
        if (val.length >= 8) strength++;

        checklist.number.className = /[0-9]/.test(val) ? "text-success" : "text-danger";
        if (/[0-9]/.test(val)) strength++;

        checklist.uppercase.className = /[A-Z]/.test(val) ? "text-success" : "text-danger";
        if (/[A-Z]/.test(val)) strength++;

        checklist.special.className = /[!@#$%^&*]/.test(val) ? "text-success" : "text-danger";
        if (/[!@#$%^&*]/.test(val)) strength++;

        let percent = (strength/4)*100;
        strengthBar.style.width = percent + "%";

        if (percent < 50) { 
            strengthBar.className="progress-bar bg-danger"; 
            strengthText.textContent="Weak"; 
            strengthText.className="fw-bold text-danger"; 
        } else if (percent < 100) { 
            strengthBar.className="progress-bar bg-warning"; 
            strengthText.textContent="Fair"; 
            strengthText.className="fw-bold text-warning"; 
        } else { 
            strengthBar.className="progress-bar bg-success"; 
            strengthText.textContent="Strong"; 
            strengthText.className="fw-bold text-success"; 
        }

        updateMatch();
    });

    // Confirm Password Match
    function updateMatch() {
        if (confirmInput.value === passwordInput.value && confirmInput.value !== "") {
            matchText.textContent = "✅ Passwords match";
            matchText.className = "form-text fw-bold text-success";
            confirmInput.setCustomValidity('');
        } else {
            matchText.textContent = "❌ Passwords do not match";
            matchText.className = "form-text fw-bold text-danger";
            confirmInput.setCustomValidity('Passwords do not match');
        }
    }
    confirmInput.addEventListener("input", updateMatch);

    // Resend OTP Timer
    function startTimer() {
        resendBtn.disabled = true;
        resendBtn.classList.add("text-muted");
        const interval = setInterval(() => {
            if (timer > 0) {
                resendBtn.textContent = `Resend OTP (${timer}s)`;
                timer--;
            } else {
                clearInterval(interval);
                resendBtn.textContent = "Resend OTP";
                resendBtn.disabled = false;
                resendBtn.classList.remove("text-muted");
                timer = 60;
            }
        }, 1000);
    }

    // Resend OTP via AJAX
    resendBtn.addEventListener('click', function() {
        startTimer();

        fetch("{% url 'resend-reset-otp' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            body: JSON.stringify({ email: document.getElementById('otp_code').value })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show a small inline message instead of alert
                const msgDiv = document.createElement('div');
                msgDiv.className = "alert alert-success text-center mt-2 py-1";
                msgDiv.textContent = "✅ OTP resent successfully!";
                resendBtn.parentNode.appendChild(msgDiv);
                setTimeout(() => msgDiv.remove(), 4000);
            } else {
                const msgDiv = document.createElement('div');
                msgDiv.className = "alert alert-danger text-center mt-2 py-1";
                msgDiv.textContent = "❌ Failed to resend OTP.";
                resendBtn.parentNode.appendChild(msgDiv);
                setTimeout(() => msgDiv.remove(), 4000);
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });
    });

    // Start initial timer
    startTimer();
});
document.addEventListener('DOMContentLoaded', function() {
    // Select all messages with the auto-hide class
    const messages = document.querySelectorAll('.message-auto-hide');
    messages.forEach(msg => {
        setTimeout(() => {
            // Fade out smoothly
            msg.style.transition = "opacity 0.5s ease-out";
            msg.style.opacity = "0";
            // Remove from DOM after fade
            setTimeout(() => msg.remove(), 500);
        }, 5000); // 5000ms = 5 seconds
    });
});
</script>

{% endblock %}
